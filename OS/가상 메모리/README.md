# 가상 메모리
가상 메모리는 크기가 다른 물리 메모리에서 일관되게 프로세스를 실행할 수 있는 기술이다. 즉 물리 메모리의 크기와 프로세스가 올라갈 메모리의 위치를 신경 쓰지 않고 프로그래밍을 하도록 지원하는것이다. (물리 메모리의 크기와 상관없이 프로세스에 커다란 메모리 공간을 제공) <br>

가상 메모리 시스템의 모든 프로세스는 물리 메모리와 별개로 자신이 메모리의 어느 위치에 있는지 상관없이 0번지부터 시작하는 연속된 메모리 공간을 가진다. <br>

---

## 가상 메모리의 크기

이론적으로 가상메모리의 크기는 무한대이다. 그러나 실제로 가상 메모리의 최대 크기는 그 컴퓨터 시스템이 가진 물리 메모리의 최대 크기로 한정되며, CPU의 비트에 따라 결정된다. ex) 32bit CPU는 약4GB <br>

이론적으로 무한대의 크기인 이유는, 프로세스들이 최대 메모리 크기보다 많은 메모리가 필요할때 가상 메모리 시스템에서는 물리 메모리의 내용 중 일부를 하드디스트 일부공간인 스왑 영역으로 옮긴다. 스왑 영역은 메모리 관리자가 관리하는 영역이다. 즉 가상 메모리에서 메모리 관리자가 사용할 수 있는 전체 크기는 물리메모리과 스왑 영역을 합한 크기이다. <br>

## 동적 주소 변환
가상 메모리 시스템의 메모리 관리자가 물리 메모리와 스왑영역을 합쳐서 프로세스가 사용하는 가상 주소를 실제 물리 메모리의 물리 주소로 변환하는 작업을 동적 주소 변환 이라고 한다(DAT). 이를 통해 데이터를 물리 메모리에 배치할 수 있다.

## 메모리 분할 방식
가상 메모리 시스템에서 운영체제를 제외한 나머지 메모리 영역을 일정한 크기로 나누어 일반 프로세스에 할당하는데, 가변 분할 방식을 세그먼테이션, 고정 분할 방식을 페이징이라고 한다. 주로 세그먼테이션-페이징 혼용 기법을 사용한다.

## 매핑 테이블
매핑테이블을 통해 가상 주소가 물리 메모리의 어느 위치에 있는지 파악할 수 있다. 페이징 기번에서는 페이지 테이블, 세그먼테이션 기법에서는 세그먼테이션 테이블을 사용한다.

### 페이징

#### 크기
물리 주소 공간을 같은 크기로 나누어 사용한다. 가상 주소의 분한된 각 영역은 페이지, 물리 메모리의 각 영역은 프레임이라고 부른다 (페이지 크기 = 프레임 크기)

#### 주소 변환
페이징 기법의 가상 주소를 VA = <P,D>로 나타내는데 VA는 가상 주소, P는 페이지, D는 페이지의 처음 위치에서 해당 주소까지의 거리(오프셋)을 나타낸다. 즉 주소 변환은 가상주소 <P,D>를 물리주소 <F,D> 로 변환 하는것이다. F는 프레임을 나타낸다. <br>
P = (가상 주소 / 한 페이지의 크기)의 몫 <br>
D = (가상 주소 / 한 페이지의 크기)의 나머지

#### 페이지 테이블 
페이지 테이블은 페이지 번호, 프레임 번호로 구성된 페이지 테이블 엔트리의 집합인데, 페이지 번호가 0번부터 정리되어 있으므로 페이지 번호를 표시할 필요가 없다. <br>
페이지 테이블의 크기는 프로세스의 크기에 비례한다.

#### 페이지 테이블 관리
페이지 테이블은 프로세스마다 하나씩 있다. 즉 특정 프로세스가 실행될 때 마다 해당 페이지 테이블을 참조한다. <br>

그러므로 페이지 테이블은 빨리 접근 할 수 있어야 하므로 물리 메모리 영역 중 운영체제 영역의 일부분에 모아놓는다. 페이지 테이블의 시작 주소를 페이지 테이블 기준 레지스터 (PTBR)에 보관한다 <br>

페이지 테이블의 크기가 커지면 프로세스가 실제 사용 가능한 메모리 영역이 줄어든다. 그러므로 페이지 테이블의 크기를 적정하게 유지해야 한다. <br>
페이지 테이블의 일부도 스왑 영역으로 옮겨질 수 있다.

#### 페이지 테이블 매핑
1) 직접 매핑
- 페이지 테이블 전체가 물리 메모리의 운영체제 영역에 존재하는 경우

2) 연관 매핑
- 테이블 전체를 스왑 영역에서 관리하는 방식으로, 모든 페이지 테이블을 스왑 영역에 저장하고 그중 일부만 물리 메모리에 가지고 있는 경우이다. 그 일부를 변환 색인 버퍼 (TLB)라고 부른다. 그러므로 페이지 번호와 프레임 번호를 둘다 표시해야 한다.
- 물리 메모리 내의 페이지 테이블을 다 검색해야 한다는 단점이 있다.

3) 집합-연관 매핑
- 연관 매핑의 문제를 개선한것으로, 페이지 테이블을 일정한 집합으로 자르고, 자른 덩어리 단위로 물리 메모리에 가져온다. 자른 페이지 테이블을 관리하는 페이지 테이블이 하나 더 필요한데, 이 디렉터리 테이블이라고 한다. 이것은 해당 페이지 테이블이 어느 위치에 있는지 표시한다.

- 디렉터리 테이블을 통해 전체 테이블을 확인하지 않아도 TLB미스를 바로 알 수 있다. 두 단계를 거쳐 물리 주소로 변환된다.

- 페이지 주소를 세분화 한것이다.

4) 역 매핑
- 페이지 번호를 기준으로 테이블을 구성하는것이 아닌, 물리 메모리의 프레임 번호를 기준으로 테이블을 구성한다. 즉 물리 메모리의 프레임에 어떤 프로세스의 어떤 페이지가 올라와 있는지 나타낸다. 

- 물리 메모리상의 프레임 수와 테이블의 열 수가 같으며, 프로세스의 수와 상관없이 테이블이 하나만 존재한다. 즉 테이블의 크기가 매우 작다. 프로세스 아이디와 페이지 번호를 모두 찾아야 한다는 단점이 있다.

- 직접 매핑, 연관 매핑, 집합-연관 매핑은 캐시 메모리 관리에서도 사용되며, 전체 페이지 테이블을 메인 메모리로 생각하면 된다.

### 세그먼테이션
물리 메모리를 프로세스의 크기에 따라 가변적으로 나누어 사용한다. 메모리를 프로세스 단위로 관리하여 페이지 테이블이 작지만, 물리 메모리의 외부 단편화로 관리가 복잡하다.

#### 세그먼테이션 테이블
세그먼트의 크기와와 물리 메모리상의 시작 주소가 저장되어 있다. 

#### 주소변환
가상주소를 VA = <S,D>로 나타낸다. S는 세그먼트 번호, D는 세그먼트 시작지점에서 해당 주소까지의 거리이다.

### 세그먼테이션-페이징 혼용
- 가상주소에서 물리주소로 변환이 일어날때 메모리 접근 권한 검사를 한다. 매핑 테이블에 메모리 접근 권한에 대한 정보를 가지고 있으며, 변환이 일어날때 검사를 한다.

- 만약 페이지 테이블에 권한 비트가 추가되면 테이블의 크기가 커진다. 그러므로 메모리 낭비가 만들어진다. 이 문제를 세그먼테이션 테이블을 이용하여 해결할 수 있는데, 페이지로 분한된 가상 주소 공간에서 서로 관련있는 영역을 하나의 세그먼트로 묶어 세그먼테이션 테이블로 관리한다. 그리고 세그먼트의 각 페이지를 해당 페이지의 테이블로 관리하는것이다.

---