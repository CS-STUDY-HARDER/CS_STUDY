# 로드 밸런서

---

## 로드 밸런서의 필요성
- 여러대의 서버를 구성하였을때 특정 서버에 문제가 발생했을때 해당 서버를 사용하는 사용자는 서비스 이용에 문제가 발생

### FWLB
- 로드밸런서는 서버 분산 외에도 방화벽을 액티브-액티브로 구성하기 위해도 사용
- 방화벽은 통과하는 패킷에 대해 정책을 확인하면서 통과시키고, 정보를 세션 테이블에 기록
- 응답패킷은 세션 테이블을 확인하여 있는 패킷이면 이미 허용된 패킷이므로 바로 통과시키고, 없는 패킷이면 요청한적이 없는 패킷의 응답으로 간주하여 폐기한다
- 방화벽 장비를 이중화 하면 경로가 두개 이상 만들어져, 정상적으로 동작하지 않는 문제 발생
- 정상적인 이중화된 방화벽을 위해 FWLB가 사용되는데, FWLB가 세션을 인식하여 방화벽 세션을 분산하고, 해당 세션이 같은 방화벽을 거치도록 분산
- FWLB에서 방화벽 장애를 대비해 방화벽끼리 테이블 동기화 하는것과 같은 방법 필요

---

## 로드 밸런서의 역할
- 여러 사용자의 요청이 오면 로드 밸런서가 분산시켜 부하를 분산한다
- 사용자는 개별 서버 IP가 아닌 동일한 가상 IP로 각 서버에 접근
- 서비스가 가능한 서버로만 요청을 분산 시킴

---

## 부하 분산 방법
- 로드 밸런서의 가상IP(VIP)에 실제서버IP(RIP)를 바인딩
- VIP로 요청시, 연결된 RIP로 요청을 전달
- 서비스 마다 다른 VIP도 가능하고, VIP 포트와 RIP 포트가 다를 수 있다

---

## 헬스 체크
- 정상적으로 동작하는 서버에만 부하를 분산하기 위해 이용

### 헬스 체크 방법

#### ICMP
- 리얼서버에 ICMP(ping)으로 수행하는 방법으로 단순히 서버가 살아있는지만 체크

#### TCP 서비스 포트
- 로드벨런서의 설정된 리얼 서버의 서비스 포트를 확인하는 방법
- 3 way handshake, 4 way handshake  

##### TCP 서비스 포트 : Half Open
- 헬스 체크 부하를 줄이기 위한 방법
- 헬스 체크 세션을 빨리 종료하기 위한 방법
- 3 way handshake, 4 way handshake가 아닌, SYN -> SYN,ACK 이후, ACK가 아닌, RST를 보내 세션을 종료

#### HTTP 상태 코드
- TCP를 통해 서비스 포트는 열리지만, 서비스가 응답해주지 못할 경우 확인하는 방법
- 3 way handshake 이후 응답으로 200을 응답하는지 체크

#### 콘텐츠 확인 (문자열 확인)
- 응답받은 애용을 확인하는 방법
- 보통 웹페이지에 사전에 지정한 문자열이 포함되었는지 확인
- WAS나 DB의 상태(백엔드 상태)도 체크 가능
- 200 응답도 중복확인하거나, 일반적이지 않은 문자열로 지정해 확인해야 정확도가 높아짐

### 헬스체크 주기와 타이머
- 로드밸런서는 주기마다 헬스 체크 패킷을 보내고, 응답 시간내에 서버에서 응답이 오지 않으면 해당 시도를 실패로 처리
- 정해진 시도 횟수만큼 다시 헬스 체크를 하여 응답을 못받으면 다운된것으로 체크

---

## 부하 분산 알고리즘

### 라운드 로빈
- 순차적으로 돌아가면서 트래픽을 분산
- 모든 장비의 총 누적 세션 수는 같아짐

### 최소 접속 방식
- 서버의 세션 부하를 확인하여 맞게 부하를 분산
- 현재 세션이 가장 적게 연결된 장비로 서비스 요청을 보내는 방법
- 확성 세션 수가 비슷하게 분산이 된다

### 해시
- 서버의 부하를 고려하지 않음
- 사용자가 같은 서버에 지속적인 접속
- 주로 출발지 IP주소와 포트, 목적지 IP주소와 포트를 이용하여 해시 계산된 값 이용 
- 각 서버에 세션을 유지해야 하는 서비스에 적합

### 스티키 옵션
- 라운드 로빈이나 최소 접속 방식을 사용하면서 한번 접속한 커넥션을 지속적으로 유지하는 방법에 사용
- 세션 테이블을 통해 같은 요청이 오면 같은 장비로 분산해 세션을 유지하는 방법
- 세션 테이블의 타임아웃 이후에는 분산 되는 장비가 달라질 수 있는 문제

---

## 구성 방식

### 원암 구성
- 중간 스위치 옆에 로드 밸런서 구성
- 부하 분산을 수행하는 트래픽에 대해서만 로드 밸런서 경유
- 한쪽 팔을 벌린 형태의 구성과 같음 (One-Arm)
- 로드 밸런서와 스위치간에 연결된 인터페이스가 한개 이상이어도(ex LACP) 스위치 옆에 연결이라면 원암 구성
- 로드밸런서 부하를 줄일 수 있고, 인라인 방법보다 확장에 유리

### 인라인 구성
- 서버로 가는 경로에 로드 밸런서 구성
- 모든 트래픽이 로드 밸런서를 경유
- 로드 밸런서에서 처리하지 않는 트래픽이 로드밸런서를 거쳐도 그 부하는 크지 않음

---

## 동작 모드

### 트랜스패런트 모드
- OSI 2계층 스위치 처럼 동작
- VIP주소와 실제 서버가 동일한 네트워크를 사용
- 기존 네트워크 대역을 사용

#### 요청시
- VIP주소로 요청이 오면 VIP주소가 실제 서버의 IP주소로 변경해 전송 (목적지 NAT)
- 목적지 MAC주소도 실제 MAC주소로 변경
- 동일한 네트워크 대역이므로 출발지 MAC주소는 변경되지 않음

#### 응답시
- 출발지 IP주소가 실제 서버의 IP에서 VIP 주소로 변경
- 목적지 MAC주소는 변경되지 않음 (목적지 MAC이 게이트웨이 MAC을 가지고 있음)

### 라우티드 모드
- 로드 밸런서가 라우팅 역할
- 로드 밸런서 기준으로 클라이언트 방향과 서버 방향이 서로 다른 네트워크

#### 요청시
- VIP주소로 요청이 오면 VIP주소가 실제 서버의 IP주소로 변경해 전송 (목적지 NAT)
- 일반 라우팅과 동일하게 로드밸런서에서 출발지와 목적지의 MAC주소 변경

#### 응답시
- 목적지 IP가 원래 사용자의 IP주소가 되는데, 이는 외부 네트워크이므로 목적지 MAC은 로드 밸런서의 MAC주소가 된다
- 로드 밸런서에서 출발지 IP를 사용자가 요청한 VIP로 변경
- 로드 밸런서에서 출발지와 목적지의 MAC주소 변경

### DSR(Direct Server Return) 모드
- 요청이 로드밸런서를 통해 서버로 유입된후 바로 서버가 사용자에게 직접 응답한다
- 로드밸런서는 사용자가 요청하는 패킷만 관여하여 로드 밸런서 전체 트래픽이 감소
- 일반적으로 응답 패킷이 더 커서 트래픽 부하 감소에 효과적
- 응답할때 로드밸런서를 지나지 않아서 원암으로 구성
- 로드 밸런서는 요청시 목적지를 실제 서버 IP로 변경하지 않고, VIP 그대로 유지하고 목적지 MAC주소만 실제 MAC주소로 변경
- 실제 서버에서 VIP와 동일한 목적자 IP인 경우에도 수신하도록 추가 설정 필요

---

## 로드 밸런서 유의사항

### 원암 구성 - 동일 네트워크 사용시

### 동일 네트워크에서 서비스 IP 호출